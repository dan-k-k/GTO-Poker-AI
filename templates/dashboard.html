<!-- templates/dashboard.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Poker Bot Decision Support System</title>
    <style>
        :root { 
            --bg: #1e1e1e; 
            --panel: #2d2d2d; 
            --accent: #007acc; 
            --text: #e0e0e0; 
            --danger: #d9534f; 
            --success: #5cb85c; 
            --highlight: #ffd700;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; justify-content: center; }
        
        .container { display: flex; gap: 20px; max-width: 1400px; width: 100%; }
        .col { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        .panel { background: var(--panel); padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid #333; }
        
        h2 { border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top: 0; font-size: 1.2em; }
        h4 { margin: 15px 0 5px; color: #888; text-transform: uppercase; font-size: 0.75em; letter-spacing: 1px; }
        label { display: block; margin: 5px 0; font-weight: bold; font-size: 0.9em; color: #ccc; }
        
        .builder-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        
        .control-group { 
            background: #333; padding: 15px; border-radius: 8px; border: 2px solid transparent; 
            transition: all 0.3s ease; opacity: 0.6;
        }
        
        .control-group.active-turn { 
            border-color: var(--success); 
            background: #3a4a3a; 
            opacity: 1;
            box-shadow: 0 0 15px rgba(92, 184, 92, 0.2);
            transform: scale(1.02);
        }

        .btn-group { display: flex; gap: 5px; margin-top: 5px; }
        input, textarea { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: white; border-radius: 4px; font-family: monospace; }
        textarea { height: 150px; font-size: 0.8em; }

        button { background: var(--accent); color: white; border: none; padding: 10px; font-weight: bold; cursor: pointer; border-radius: 4px; transition: background 0.2s; }
        button:hover { background: #005f9e; }
        button.secondary { background: #444; }
        button.secondary:hover { background: #555; }
        button.action-btn { flex: 1; font-size: 0.8em; padding: 8px 0; }

        .table-visual {
            background: #153e20; border-radius: 12px; padding: 20px; text-align: center; border: 4px solid #3e2723; margin-bottom: 20px;
        }
        .pot-display { font-size: 1.2em; font-weight: bold; color: #ffd700; margin-bottom: 10px; }
        .cards-container { display: flex; justify-content: center; gap: 10px; min-height: 60px; }
        .card-box { 
            background: white; color: black; width: 40px; height: 56px; border-radius: 4px; 
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1em;
        }
        .card-box.red { color: #d00; }

        .log-container { background: #111; padding: 10px; border-radius: 4px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em; border: 1px solid #333; }
        .log-entry { padding: 4px 0; border-bottom: 1px solid #222; }
        .log-street { color: var(--highlight); font-weight: bold; margin-top: 10px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .log-p0 { color: #88ccff; }
        .log-p1 { color: #ff8888; }
        
        #result-box { display: none; border-left: 5px solid var(--accent); padding-left: 15px; margin-top: 20px; }
        .big-action { font-size: 2.5em; text-align: center; color: var(--success); margin: 15px 0; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="col" style="flex: 1.2;">
        <div class="panel">
            <h2>1. Game Controls</h2>
            
            <div class="builder-controls">
                <div id="p0-group" class="control-group active-turn">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label style="color: #88ccff;">PLAYER 0 (Seat 0)</label>
                        <div id="p0-cards" style="display:flex; gap:5px;"></div>
                    </div>
                    <div style="font-size:0.8em; margin-bottom:5px;">Stack: <span id="p0-stack">199</span></div>
                    
                    <div class="btn-group">
                        <button class="secondary action-btn" onclick="addHistory(0, 0, 0)">Fold</button>
                        <button class="secondary action-btn" onclick="addHistory(0, 1, null)">Check/Call</button>
                    </div>
                    <div style="margin-top:5px; display:flex; gap:5px;">
                        <input type="number" id="p0-amt" placeholder="Raise To" style="width: 70px;">
                        <button class="secondary action-btn" onclick="addHistory(0, 2, document.getElementById('p0-amt').value)">Bet/Raise</button>
                    </div>
                </div>

                <div id="p1-group" class="control-group">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label style="color: #ff8888;">PLAYER 1 (Seat 1)</label>
                        <div id="p1-cards" style="display:flex; gap:5px;"></div>
                    </div>
                    <div style="font-size:0.8em; margin-bottom:5px;">Stack: <span id="p1-stack">198</span></div>

                    <div class="btn-group">
                        <button class="secondary action-btn" onclick="addHistory(1, 0, 0)">Fold</button>
                        <button class="secondary action-btn" onclick="addHistory(1, 1, null)">Check/Call</button>
                    </div>
                    <div style="margin-top:5px; display:flex; gap:5px;">
                        <input type="number" id="p1-amt" placeholder="Raise To" style="width: 70px;">
                        <button class="secondary action-btn" onclick="addHistory(1, 2, document.getElementById('p1-amt').value)">Bet/Raise</button>
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="secondary" onclick="nextStreet()">Next Street (Deal)</button>
                <button class="secondary" style="background: var(--danger);" onclick="resetBuilder()">Reset Hand</button>
            </div>
        </div>

        <div class="panel">
            <h2>2. Generated Request (JSON)</h2>
            <textarea id="jsonInput"></textarea>
            <button onclick="getRecommendation()" style="margin-top:10px;">Ask Bot (Run Inference)</button>
        </div>
    </div>

    <div class="col">
        <div class="panel">
            <h2>3. Table Visual</h2>
            <div class="table-visual">
                <div class="pot-display">POT: <span id="visual-pot">3</span></div>
                <div class="cards-container" id="visual-board"></div>
            </div>

            <h4>Hand History Log</h4>
            <div class="log-container" id="game-log"></div>
        </div>

        <div class="panel">
            <h2>4. AI Suggestion</h2>
            <div id="loading" style="display:none; text-align: center; padding: 20px; color: var(--accent);">thinking...</div>
            <div id="result-box">
                <div class="stat-row">
                    <span>Suggested Action:</span>
                    <strong style="color: #aaa">For <span id="ai-player-target">-</span></strong>
                </div>
                <div class="big-action" id="action-text">WAITING...</div>
                <div class="stat-row">
                    <span>Raise To:</span>
                    <strong id="amount-text">-</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let builderState = {
        pot: 3, 
        initial_stacks: [200, 200],
        stacks: [199, 198], 
        current_bets: [1, 2],
        stage: 0,
        past_actions: [],
        dealer_id: 0,
        hole_cards: [["Ah", "Kd"], ["Qs", "Js"]], 
        deck: ["2h", "7s", "Td", "Ks", "Ac"], 
        community_cards: []
    };

    // --- Core Logic ---

    function getToMove() {
        if (builderState.past_actions.length === 0) return 0;
        const lastLog = builderState.past_actions[builderState.past_actions.length - 1];

        // If we just entered a NEW street, reset turn order based on poker rules
        if (builderState.stage > lastLog.stage) {
            // Preflop (0): SB (0) acts first
            // Postflop (>0): BB (1) acts first
            return builderState.stage === 0 ? 0 : 1;
        }

        // Otherwise, standard toggle within the street
        return 1 - lastLog.seat_id;
    }

    function addHistory(seat, actionType, inputTotal) {
        let amountAdded = 0;
        
        if (actionType === 1) { // Check/Call
            const highestBet = Math.max(...builderState.current_bets);
            amountAdded = highestBet - builderState.current_bets[seat];
        } else if (actionType === 2) { // Raise
            const targetTotal = parseInt(inputTotal);
            if (!targetTotal || targetTotal < builderState.current_bets[seat]) {
                alert("Invalid Raise Amount"); return;
            }
            amountAdded = targetTotal - builderState.current_bets[seat];
        }

        if (amountAdded > builderState.stacks[seat]) {
            alert("Not enough chips! Adjusted to All-in.");
            amountAdded = builderState.stacks[seat];
        }

        builderState.stacks[seat] -= amountAdded;
        builderState.current_bets[seat] += amountAdded;
        builderState.pot += amountAdded;

        builderState.past_actions.push({
            seat_id: seat, stage: builderState.stage, action_type: actionType, amount_added: amountAdded
        });

        renderState();
        
        if (actionType === 0) alert("Hand Over (Fold)");
        else checkAutoNextStreet();
    }

    function checkAutoNextStreet() {
        if (builderState.stage >= 3) return;
        if (builderState.current_bets[0] !== builderState.current_bets[1]) return;

        const lastLog = builderState.past_actions[builderState.past_actions.length - 1];
        const lastActor = lastLog.seat_id;
        let shouldAdvance = false;

        // Preflop ends when BB (1) acts. Postflop ends when Button (0) acts.
        if (builderState.stage === 0) { if (lastActor === 1) shouldAdvance = true; } 
        else { if (lastActor === 0) shouldAdvance = true; }

        if (shouldAdvance) setTimeout(() => nextStreet(), 500);
    }

    function nextStreet() {
        if (builderState.stage >= 3) return;
        builderState.stage += 1;
        builderState.current_bets = [0, 0];
        
        if (builderState.stage === 1) builderState.community_cards = builderState.deck.slice(0,3);
        if (builderState.stage === 2) builderState.community_cards = builderState.deck.slice(0,4);
        if (builderState.stage === 3) builderState.community_cards = builderState.deck.slice(0,5);
        
        renderState();
    }

    function resetBuilder() {
        builderState = {
            pot: 3, initial_stacks: [200, 200], stacks: [199, 198], current_bets: [1, 2],
            stage: 0, past_actions: [], dealer_id: 0, hole_cards: [["Ah", "Kd"], ["Qs", "Js"]],
            deck: ["2h", "7s", "Td", "Ks", "Ac"], community_cards: []
        };
        renderState();
    }

    // --- Rendering ---

    function renderHoleCards() {
        const p0Div = document.getElementById('p0-cards');
        const p1Div = document.getElementById('p1-cards');
        
        // Helper to create card HTML
        const createCardEl = (cardStr) => {
            const isRed = (cardStr[1] === 'd' || cardStr[1] === 'h');
            const icon = {'d':'♦','h':'♥','s':'♠','c':'♣'}[cardStr[1]];
            const el = document.createElement('div');
            // Small styling for hole cards
            el.style.cssText = `
                background: white; color: ${isRed ? '#d00' : 'black'}; 
                width: 25px; height: 35px; border-radius: 3px; 
                display: flex; align-items: center; justify-content: center; 
                font-weight: bold; font-size: 0.9em; border: 1px solid #999;
            `;
            el.innerText = cardStr[0] + icon;
            return el;
        };

        // Clear previous
        p0Div.innerHTML = '';
        p1Div.innerHTML = '';

        // Render P0 Cards
        builderState.hole_cards[0].forEach(c => p0Div.appendChild(createCardEl(c)));
        
        // Render P1 Cards
        builderState.hole_cards[1].forEach(c => p1Div.appendChild(createCardEl(c)));
    }

    function renderState() {
        const json = {
            pot: builderState.pot, current_bets: builderState.current_bets, stacks: builderState.stacks,
            initial_stacks: builderState.initial_stacks, hole_cards: builderState.hole_cards,
            community_cards: builderState.community_cards, dealer_id: builderState.dealer_id,
            to_move: getToMove(), stage: builderState.stage, past_actions: builderState.past_actions,
            legal_actions: [0, 1, 2]
        };
        document.getElementById('jsonInput').value = JSON.stringify(json, null, 2);

        const toMove = getToMove();
        document.getElementById('p0-group').className = `control-group ${toMove===0 ? 'active-turn' : ''}`;
        document.getElementById('p1-group').className = `control-group ${toMove===1 ? 'active-turn' : ''}`;
        document.getElementById('p0-stack').innerText = builderState.stacks[0];
        document.getElementById('p1-stack').innerText = builderState.stacks[1];
        document.getElementById('visual-pot').innerText = builderState.pot;

        renderBoard();
        renderHoleCards();
        renderLog();
    }

    function renderBoard() {
        const boardDiv = document.getElementById('visual-board');
        const streetNames = ["Preflop", "Flop", "Turn", "River"];
        
        if (builderState.community_cards.length === 0) {
            boardDiv.innerHTML = `<span style="color:#aaa; font-size:0.8em; align-self:center;">${streetNames[builderState.stage]}</span>`;
            return;
        }
        boardDiv.innerHTML = '';
        builderState.community_cards.forEach(c => {
            const isRed = (c[1] === 'd' || c[1] === 'h');
            const icon = {'d':'♦','h':'♥','s':'♠','c':'♣'}[c[1]];
            const el = document.createElement('div'); el.className = `card-box ${isRed ? 'red' : ''}`; el.innerText = c[0] + icon;
            boardDiv.appendChild(el);
        });
    }

    // Helper to render the street header string
    function renderStreetHeader(stage) {
        const names = ["PREFLOP", "FLOP", "TURN", "RIVER"];
        let cardsStr = "";
        if(stage === 1) cardsStr = builderState.deck.slice(0,3).join(' ');
        if(stage === 2) cardsStr = builderState.deck[3];
        if(stage === 3) cardsStr = builderState.deck[4];
        
        addLogLine(`--- ${names[stage]} ${cardsStr ? '('+cardsStr+')' : ''} ---`, 'log-street');
    }

    function renderLog() {
        const logDiv = document.getElementById('game-log');
        logDiv.innerHTML = '';
        addLogLine('Game Start: Blinds posted (1/2)', 'gray');

        let simCurrentBets = [1, 2]; 
        let currentStageProcessed = -1;

        // 1. Replay past actions
        builderState.past_actions.forEach(act => {
            if (act.stage > currentStageProcessed) {
                renderStreetHeader(act.stage);
                currentStageProcessed = act.stage;
                
                if (act.stage === 0) simCurrentBets = [1, 2];
                else simCurrentBets = [0, 0]; 
            }

            simCurrentBets[act.seat_id] += act.amount_added;
            const totalBet = simCurrentBets[act.seat_id];
            
            const pName = `P${act.seat_id}`;
            const pClass = act.seat_id === 0 ? 'log-p0' : 'log-p1';
            let actionText = act.action_type === 0 ? "Folds" : act.action_type === 1 ? (act.amount_added === 0 ? "Checks" : `Calls ${act.amount_added}`) : `Raises TO ${totalBet}`;

            const entry = document.createElement('div'); entry.className = 'log-entry';
            entry.innerHTML = `<span class="${pClass}">${pName}</span> ${actionText}`;
            logDiv.appendChild(entry);
        });

        // 2. *** NEW FIX *** // If the actual game stage is ahead of the last processed action stage, 
        // it means we just entered a new street but haven't acted yet. Print header.
        if (builderState.stage > currentStageProcessed) {
             renderStreetHeader(builderState.stage);
        }

        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function addLogLine(text, cssClass) {
        const div = document.createElement('div'); div.className = cssClass || 'log-entry';
        div.innerText = text; document.getElementById('game-log').appendChild(div);
    }

    async function getRecommendation() {
        const inputData = document.getElementById('jsonInput').value;
        const resultBox = document.getElementById('result-box');
        const loading = document.getElementById('loading');
        
        resultBox.style.display = 'none'; loading.style.display = 'block';

        try {
            const response = await fetch('http://localhost:8000/get_optimal_action', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: inputData
            });
            const data = await response.json();
            loading.style.display = 'none'; resultBox.style.display = 'block';
            
            const req = JSON.parse(inputData);
            document.getElementById('ai-player-target').innerText = "Player " + req.to_move;
            
            if (data.action_type) {
                const color = data.action_type === 'fold' ? '#d9534f' : data.action_type === 'raise' ? '#ffd700' : '#5cb85c';
                const actionDisplay = document.getElementById('action-text');
                actionDisplay.innerText = data.action_type.toUpperCase(); actionDisplay.style.color = color;
                document.getElementById('amount-text').innerText = data.amount !== null ? data.amount : "N/A";
            } else { document.getElementById('action-text').innerText = "ERROR"; }
        } catch (error) { loading.style.display = 'none'; alert("API Error. Ensure server is running."); }
    }

    renderState();
</script>
</body>
</html>

